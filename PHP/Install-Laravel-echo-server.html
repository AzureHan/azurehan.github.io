<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>安装 Laravel-echo-server | Azure&#39;s Notebook</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.003d6652.css" as="style"><link rel="preload" href="/assets/js/app.ed19ba6d.js" as="script"><link rel="preload" href="/assets/js/25.b1041c73.js" as="script"><link rel="prefetch" href="/assets/js/10.725adfc7.js"><link rel="prefetch" href="/assets/js/11.d37d9b8b.js"><link rel="prefetch" href="/assets/js/12.7381f097.js"><link rel="prefetch" href="/assets/js/13.7bfd8c5c.js"><link rel="prefetch" href="/assets/js/14.0851aedb.js"><link rel="prefetch" href="/assets/js/15.4aa69a87.js"><link rel="prefetch" href="/assets/js/16.e91cefc8.js"><link rel="prefetch" href="/assets/js/17.bf11e506.js"><link rel="prefetch" href="/assets/js/18.cfde5974.js"><link rel="prefetch" href="/assets/js/19.6182ee07.js"><link rel="prefetch" href="/assets/js/2.af91441d.js"><link rel="prefetch" href="/assets/js/20.be8f3590.js"><link rel="prefetch" href="/assets/js/21.0c23aafe.js"><link rel="prefetch" href="/assets/js/22.72f4f18e.js"><link rel="prefetch" href="/assets/js/23.963bec41.js"><link rel="prefetch" href="/assets/js/24.e713fe21.js"><link rel="prefetch" href="/assets/js/26.db6b8971.js"><link rel="prefetch" href="/assets/js/27.8d89063d.js"><link rel="prefetch" href="/assets/js/28.c52d33c4.js"><link rel="prefetch" href="/assets/js/29.76a01272.js"><link rel="prefetch" href="/assets/js/3.3e582861.js"><link rel="prefetch" href="/assets/js/30.c68724aa.js"><link rel="prefetch" href="/assets/js/31.527e2096.js"><link rel="prefetch" href="/assets/js/32.e1cfa260.js"><link rel="prefetch" href="/assets/js/4.3bfa2392.js"><link rel="prefetch" href="/assets/js/5.1a95e6c3.js"><link rel="prefetch" href="/assets/js/6.aedd08db.js"><link rel="prefetch" href="/assets/js/7.45f2728a.js"><link rel="prefetch" href="/assets/js/8.5fcdd9e7.js"><link rel="prefetch" href="/assets/js/9.778a7fc4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.003d6652.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Azure's Notebook</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><!---->  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>Data-Structure</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Network</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>PHP</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/PHP/" class="sidebar-link">PHP 笔记</a></li><li><a href="/PHP/Control-Inversion.html" class="sidebar-link">PHP 控制反转</a></li><li><a href="/PHP/Autoload-and-Composer.html" class="sidebar-link">PHP 类自加载与 Composer 原理</a></li><li><a href="/PHP/Object-oriented.html" class="sidebar-link">PHP 面向对象</a></li><li><a href="/PHP/Laravel-Middleware.html" class="sidebar-link">Laravel 中间件</a></li><li><a href="/PHP/Install-Laravel-echo-server.html" class="active sidebar-link">安装 Laravel-echo-server</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/PHP/Install-Laravel-echo-server.html#创建项目" class="sidebar-link">创建项目</a></li><li class="sidebar-sub-header"><a href="/PHP/Install-Laravel-echo-server.html#包安装" class="sidebar-link">包安装</a></li><li class="sidebar-sub-header"><a href="/PHP/Install-Laravel-echo-server.html#发布代码" class="sidebar-link">发布代码</a></li><li class="sidebar-sub-header"><a href="/PHP/Install-Laravel-echo-server.html#编写代码" class="sidebar-link">编写代码</a></li><li class="sidebar-sub-header"><a href="/PHP/Install-Laravel-echo-server.html#运作" class="sidebar-link">运作</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>MySQL</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="安装-laravel-echo-server"><a href="#安装-laravel-echo-server" aria-hidden="true" class="header-anchor">#</a> 安装 Laravel-echo-server</h1> <blockquote><p>日期 : 2018-03-04</p></blockquote> <h2 id="创建项目"><a href="#创建项目" aria-hidden="true" class="header-anchor">#</a> 创建项目</h2> <p><code>composer create-project laravel/laravel=5.5 &lt;项目名&gt;</code></p> <p><code>php artisan make:auth</code></p> <p>Homestead 虚拟机为此站点添加配置</p> <p>添加宿主机的 host 规则</p> <h2 id="包安装"><a href="#包安装" aria-hidden="true" class="header-anchor">#</a> 包安装</h2> <ul><li>为项目安装 PRedis 库</li></ul> <p><code>composer require predis/predis</code></p> <ul><li>全局安装 Laravel Echo 服务</li></ul> <p><code>sudo npm install -g laravel-echo-server</code></p> <ul><li>为项目安装前端包</li></ul> <p><code>npm install</code></p> <ul><li>为项目安装 Laravel Echo</li></ul> <p><code>npm install --save laravel-echo</code></p> <h2 id="发布代码"><a href="#发布代码" aria-hidden="true" class="header-anchor">#</a> 发布代码</h2> <ul><li>启用广播服务</li></ul> <p>修改 <code>config/app.php</code> 中</p> <p>取消 <code>App\Providers\BroadcastServiceProvider</code> 所在行的注释</p> <p>修改 <code>.env</code> 中</p> <p><code>BROADCAST_DRIVER</code> 设为 <code>redis</code></p> <p><code>QUEUE_DRIVER</code> 设为 <code>redis</code></p> <ul><li>初始化 Laravel Echo 服务</li></ul> <p><code>laravel-echo-server init</code></p> <p>初始化的选择为以下所示</p> <div class="language-shell extra-class"><pre class="language-shell"><code>Do you want to run this server <span class="token keyword">in</span> development mode? Yes
Which port would you like to serve from? 6001
Which database would you like to use to store presence channel members? redis
Enter the host of your Laravel authentication server. http://<span class="token operator">&lt;</span>域名<span class="token operator">&gt;</span>
Will you be serving on http or https? http
Do you want to generate a client ID/Key <span class="token keyword">for</span> HTTP API? No
Do you want to setup cross domain access to the API? No
</code></pre></div><ul><li>在视图中引入 socket.io.js</li></ul> <p>将以下代码加入到视图 <code>layouts/app.blade.php</code> 的 <code>&lt;head&gt;</code> 标签之间</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;//{{ Request::getHost() }}:6001/socket.io/socket.io.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><ul><li>Javascript 代码中启用 Laravel Echo</li></ul> <p>将以下代码加入到 <code>resources/assets/js/bootstrap.js</code> 的最后</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> Echo <span class="token keyword">from</span> <span class="token string">&quot;laravel-echo&quot;</span>

window<span class="token punctuation">.</span>Echo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Echo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    broadcaster<span class="token punctuation">:</span> <span class="token string">'socket.io'</span><span class="token punctuation">,</span>
    host<span class="token punctuation">:</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hostname <span class="token operator">+</span> <span class="token string">':6001'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>生产前端代码</li></ul> <p><code>npm run prod</code></p> <h2 id="编写代码"><a href="#编写代码" aria-hidden="true" class="header-anchor">#</a> 编写代码</h2> <ul><li>创建 &quot;ShippingStatusUpdated&quot; 事件</li></ul> <p><code>php artisan make:event ShippingStatusUpdated</code></p> <p>为启用广播，在新创建的事件源码中</p> <p><code>class ShippingStatusUpdated</code> 后加上 <code>implements ShouldBroadcast</code></p> <p>添加属性</p> <p><code>public $update</code></p> <p>构造方法添中加</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// 测试数据</span>
<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">update</span> <span class="token operator">=</span> <span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'order_id'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'user_id'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre></div><p>将方法 broadcastOn 中的返回改为</p> <p><code>new PrivateChannel('order.'.$this-&gt;update-&gt;order_id)</code></p> <ul><li>频道路由加入验证规则</li></ul> <p>将以下代码加入到 <code>routes/channels.php</code></p> <div class="language-php extra-class"><pre class="language-php"><code>Broadcast<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'order.{orderId}'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$orderId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 测试规则</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>在视图文件 <code>home.blade.php</code> 中 <code>div#app</code> 之后添加以下代码</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
    <span class="token comment">// 测试频道</span>
    Echo<span class="token punctuation">.</span><span class="token keyword">private</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`order.1`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'ShippingStatusUpdated'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="运作"><a href="#运作" aria-hidden="true" class="header-anchor">#</a> 运作</h2> <ul><li>开启 Laravel Echo 服务</li></ul> <p><code>laravel-echo-server start</code></p> <ul><li>开启 Redis 队列</li></ul> <p><code>php artisan queue:work redis --tries=3</code></p> <ul><li><p>注册账号并 <strong>登录</strong> 进入 <code>/home</code> 页面</p></li> <li><p>触发事件进行测试</p></li></ul> <p>进入 <code>php artisan tinker</code></p> <p>输入 <code>event(new App\Events\ShippingStatusUpdated())</code> 回车</p> <ul><li><p>检查浏览器控制台输出信息</p></li> <li><p>完成搭建</p></li></ul></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/PHP/Laravel-Middleware.html" class="prev">
          Laravel 中间件
        </a></span> <span class="next"><a href="/MySQL/">
          MySQL 笔记
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/25.b1041c73.js" defer></script><script src="/assets/js/app.ed19ba6d.js" defer></script>
  </body>
</html>
