(window.webpackJsonp=window.webpackJsonp||[]).push([[25],{191:function(t,a,s){"use strict";s.r(a);var n=s(0),e=Object(n.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("div",{staticClass:"content"},[s("h1",{attrs:{id:"安装-laravel-echo-server"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装-laravel-echo-server","aria-hidden":"true"}},[t._v("#")]),t._v(" 安装 Laravel-echo-server")]),t._v(" "),s("blockquote",[s("p",[t._v("日期 : 2018-03-04")])]),t._v(" "),s("h2",{attrs:{id:"创建项目"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建项目","aria-hidden":"true"}},[t._v("#")]),t._v(" 创建项目")]),t._v(" "),s("p",[s("code",[t._v("composer create-project laravel/laravel=5.5 <项目名>")])]),t._v(" "),s("p",[s("code",[t._v("php artisan make:auth")])]),t._v(" "),s("p",[t._v("Homestead 虚拟机为此站点添加配置")]),t._v(" "),s("p",[t._v("添加宿主机的 host 规则")]),t._v(" "),s("h2",{attrs:{id:"包安装"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#包安装","aria-hidden":"true"}},[t._v("#")]),t._v(" 包安装")]),t._v(" "),s("ul",[s("li",[t._v("为项目安装 PRedis 库")])]),t._v(" "),s("p",[s("code",[t._v("composer require predis/predis")])]),t._v(" "),s("ul",[s("li",[t._v("全局安装 Laravel Echo 服务")])]),t._v(" "),s("p",[s("code",[t._v("sudo npm install -g laravel-echo-server")])]),t._v(" "),s("ul",[s("li",[t._v("为项目安装前端包")])]),t._v(" "),s("p",[s("code",[t._v("npm install")])]),t._v(" "),s("ul",[s("li",[t._v("为项目安装 Laravel Echo")])]),t._v(" "),s("p",[s("code",[t._v("npm install --save laravel-echo")])]),t._v(" "),s("h2",{attrs:{id:"发布代码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#发布代码","aria-hidden":"true"}},[t._v("#")]),t._v(" 发布代码")]),t._v(" "),s("ul",[s("li",[t._v("启用广播服务")])]),t._v(" "),s("p",[t._v("修改 "),s("code",[t._v("config/app.php")]),t._v(" 中")]),t._v(" "),s("p",[t._v("取消 "),s("code",[t._v("App\\Providers\\BroadcastServiceProvider")]),t._v(" 所在行的注释")]),t._v(" "),s("p",[t._v("修改 "),s("code",[t._v(".env")]),t._v(" 中")]),t._v(" "),s("p",[s("code",[t._v("BROADCAST_DRIVER")]),t._v(" 设为 "),s("code",[t._v("redis")])]),t._v(" "),s("p",[s("code",[t._v("QUEUE_DRIVER")]),t._v(" 设为 "),s("code",[t._v("redis")])]),t._v(" "),s("ul",[s("li",[t._v("初始化 Laravel Echo 服务")])]),t._v(" "),s("p",[s("code",[t._v("laravel-echo-server init")])]),t._v(" "),s("p",[t._v("初始化的选择为以下所示")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("Do you want to run this server "),s("span",{attrs:{class:"token keyword"}},[t._v("in")]),t._v(" development mode? Yes\nWhich port would you like to serve from? 6001\nWhich database would you like to use to store presence channel members? redis\nEnter the host of your Laravel authentication server. http://"),s("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("域名"),s("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\nWill you be serving on http or https? http\nDo you want to generate a client ID/Key "),s("span",{attrs:{class:"token keyword"}},[t._v("for")]),t._v(" HTTP API? No\nDo you want to setup cross domain access to the API? No\n")])])]),s("ul",[s("li",[t._v("在视图中引入 socket.io.js")])]),t._v(" "),s("p",[t._v("将以下代码加入到视图 "),s("code",[t._v("layouts/app.blade.php")]),t._v(" 的 "),s("code",[t._v("<head>")]),t._v(" 标签之间")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("script src"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token string"}},[t._v('"//{{ Request::getHost() }}:6001/socket.io/socket.io.js"')]),s("span",{attrs:{class:"token operator"}},[t._v(">")]),s("span",{attrs:{class:"token operator"}},[t._v("<")]),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("script"),s("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),s("ul",[s("li",[t._v("Javascript 代码中启用 Laravel Echo")])]),t._v(" "),s("p",[t._v("将以下代码加入到 "),s("code",[t._v("resources/assets/js/bootstrap.js")]),t._v(" 的最后")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Echo "),s("span",{attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{attrs:{class:"token string"}},[t._v('"laravel-echo"')]),t._v("\n\nwindow"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Echo "),s("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{attrs:{class:"token class-name"}},[t._v("Echo")]),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    broadcaster"),s("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{attrs:{class:"token string"}},[t._v("'socket.io'")]),s("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    host"),s("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" window"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("location"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("hostname "),s("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{attrs:{class:"token string"}},[t._v("':6001'")]),s("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("ul",[s("li",[t._v("生产前端代码")])]),t._v(" "),s("p",[s("code",[t._v("npm run prod")])]),t._v(" "),s("h2",{attrs:{id:"编写代码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写代码","aria-hidden":"true"}},[t._v("#")]),t._v(" 编写代码")]),t._v(" "),s("ul",[s("li",[t._v('创建 "ShippingStatusUpdated" 事件')])]),t._v(" "),s("p",[s("code",[t._v("php artisan make:event ShippingStatusUpdated")])]),t._v(" "),s("p",[t._v("为启用广播，在新创建的事件源码中")]),t._v(" "),s("p",[s("code",[t._v("class ShippingStatusUpdated")]),t._v(" 后加上 "),s("code",[t._v("implements ShouldBroadcast")])]),t._v(" "),s("p",[t._v("添加属性")]),t._v(" "),s("p",[s("code",[t._v("public $update")])]),t._v(" "),s("p",[t._v("构造方法添中加")]),t._v(" "),s("div",{staticClass:"language-php extra-class"},[s("pre",{pre:!0,attrs:{class:"language-php"}},[s("code",[s("span",{attrs:{class:"token comment"}},[t._v("// 测试数据")]),t._v("\n"),s("span",{attrs:{class:"token variable"}},[t._v("$this")]),s("span",{attrs:{class:"token operator"}},[t._v("-")]),s("span",{attrs:{class:"token operator"}},[t._v(">")]),s("span",{attrs:{class:"token property"}},[t._v("update")]),t._v(" "),s("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("object"),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),s("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'order_id'")]),t._v(" "),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{attrs:{class:"token number"}},[t._v("1")]),s("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'user_id'")]),t._v(" "),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{attrs:{class:"token number"}},[t._v("1")]),s("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("p",[t._v("将方法 broadcastOn 中的返回改为")]),t._v(" "),s("p",[s("code",[t._v("new PrivateChannel('order.'.$this->update->order_id)")])]),t._v(" "),s("ul",[s("li",[t._v("频道路由加入验证规则")])]),t._v(" "),s("p",[t._v("将以下代码加入到 "),s("code",[t._v("routes/channels.php")])]),t._v(" "),s("div",{staticClass:"language-php extra-class"},[s("pre",{pre:!0,attrs:{class:"language-php"}},[s("code",[t._v("Broadcast"),s("span",{attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{attrs:{class:"token function"}},[t._v("channel")]),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'order.{orderId}'")]),s("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{attrs:{class:"token variable"}},[t._v("$user")]),s("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{attrs:{class:"token variable"}},[t._v("$orderId")]),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),s("span",{attrs:{class:"token comment"}},[t._v("// 测试规则")]),t._v("\n    "),s("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{attrs:{class:"token boolean"}},[t._v("true")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("ul",[s("li",[t._v("在视图文件 "),s("code",[t._v("home.blade.php")]),t._v(" 中 "),s("code",[t._v("div#app")]),t._v(" 之后添加以下代码")])]),t._v(" "),s("div",{staticClass:"language-html extra-class"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[s("span",{attrs:{class:"token tag"}},[s("span",{attrs:{class:"token tag"}},[s("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),s("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{attrs:{class:"token script language-javascript"}},[t._v("\n    "),s("span",{attrs:{class:"token comment"}},[t._v("// 测试频道")]),t._v("\n    Echo"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{attrs:{class:"token keyword"}},[t._v("private")]),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{attrs:{class:"token template-string"}},[s("span",{attrs:{class:"token string"}},[t._v("`order.1`")])]),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{attrs:{class:"token function"}},[t._v("listen")]),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{attrs:{class:"token string"}},[t._v("'ShippingStatusUpdated'")]),s("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{attrs:{class:"token function"}},[t._v("log")]),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("update"),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")]),s("span",{attrs:{class:"token tag"}},[s("span",{attrs:{class:"token tag"}},[s("span",{attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),s("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("h2",{attrs:{id:"运作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#运作","aria-hidden":"true"}},[t._v("#")]),t._v(" 运作")]),t._v(" "),s("ul",[s("li",[t._v("开启 Laravel Echo 服务")])]),t._v(" "),s("p",[s("code",[t._v("laravel-echo-server start")])]),t._v(" "),s("ul",[s("li",[t._v("开启 Redis 队列")])]),t._v(" "),s("p",[s("code",[t._v("php artisan queue:work redis --tries=3")])]),t._v(" "),s("ul",[s("li",[s("p",[t._v("注册账号并 "),s("strong",[t._v("登录")]),t._v(" 进入 "),s("code",[t._v("/home")]),t._v(" 页面")])]),t._v(" "),s("li",[s("p",[t._v("触发事件进行测试")])])]),t._v(" "),s("p",[t._v("进入 "),s("code",[t._v("php artisan tinker")])]),t._v(" "),s("p",[t._v("输入 "),s("code",[t._v("event(new App\\Events\\ShippingStatusUpdated())")]),t._v(" 回车")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("检查浏览器控制台输出信息")])]),t._v(" "),s("li",[s("p",[t._v("完成搭建")])])])])}],!1,null,null,null);e.options.__file="Install-Laravel-echo-server.md";a.default=e.exports}}]);